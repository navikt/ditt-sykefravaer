name: 'Generate Playwright test report'

inputs:
  GITHUB_TOKEN:
    required: true
    type: string
  NAIS_WORKLOAD_IDENTITY_PROVIDER:
    required: true
    type: string
  NAIS_MANAGEMENT_PROJECT_ID:
    required: true
    type: string

runs:
  using: composite
  steps:
    - uses: ./.github/workflows/actions/setup-node
      with:
        GITHUB_TOKEN: ${{ inputs.GITHUB_TOKEN }}
    - name: Last ned rapporter
      uses: actions/download-artifact@v4
      with:
        path: all-blob-reports
        pattern: blob-report-*
        merge-multiple: true

    - name: Merge til HTML Report
      shell: bash
      run: npx playwright merge-reports --reporter html ./all-blob-reports

    - name: Last opp til CDN
      uses: nais/deploy/actions/cdn-upload/v2@master
      with:
        team: flex
        source: playwright-report
        destination: /${{ github.repository }}/${{ github.run_number }}
        identity_provider: ${{ inputs.NAIS_WORKLOAD_IDENTITY_PROVIDER }}
        project_id: ${{ inputs.NAIS_MANAGEMENT_PROJECT_ID }}

    - name: Merge til json rapport
      shell: bash
      run: npx playwright merge-reports --reporter json  ./all-blob-reports > playwright-report/report.json

    - name: Lag GHA summary
      shell: bash
      run: |
        total_tests=$(jq '.stats.expected + .stats.unexpected' playwright-report/report.json)
        passed_tests=$(jq '.stats.expected' playwright-report/report.json)
        failed_tests=$(jq '.stats.unexpected' playwright-report/report.json)
        failed_test_info=$(jq -r '.suites[].suites[].specs[] | select(.ok == false) | "\(.title) (\(.file), \(.tests[].projectName))"' playwright-report/report.json)

        echo "## Playwright Test Report Summary" >> $GITHUB_STEP_SUMMARY
        echo "Total tests: $total_tests âœ…" >> $GITHUB_STEP_SUMMARY
        echo "Passed tests: $passed_tests âœ…" >> $GITHUB_STEP_SUMMARY

        if [ "$failed_tests" -gt 0 ]; then
          echo "Failed tests: $failed_tests âŒ" >> $GITHUB_STEP_SUMMARY
          echo "### Failed Tests:" >> $GITHUB_STEP_SUMMARY
          while IFS= read -r test; do
            echo "- $test âŒ" >> $GITHUB_STEP_SUMMARY
          done <<< "$failed_test_info"
        else
          echo "Failed tests: $failed_tests ðŸ”¹" >> $GITHUB_STEP_SUMMARY
        fi

        echo "Se hele rapporten [her](https://cdn.nav.no/flex/${{ github.repository }}/${{ github.run_number }}/playwright-report/index.html)." >> $GITHUB_STEP_SUMMARY
