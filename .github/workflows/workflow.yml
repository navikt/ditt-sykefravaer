name: workflow
on: push

jobs:
  felles-workflow:
    uses: navikt/flex-github-actions-workflows/.github/workflows/next-js.yml@next
    with:
      app: ${{ github.event.repository.name }}
    secrets: inherit

  cypress:
    needs: felles-workflow
    runs-on: ubuntu-latest
    steps:
      - name: cache workspace
        uses: actions/cache@v3
        with:
          path: ${{ github.workspace }}
          key: ${{ github.sha }}
      - name: Cache Cypress binary
        uses: actions/cache@v3
        with:
          path: ~/.cache/Cypress
          key: cypress-${{ runner.os }}-cypress-pr-${{ hashFiles('**/package.json') }}
      - name: Kj√∏r cypress
        uses: cypress-io/github-action@v2
        with:
          install: false
          record: false
          config-file: cypress.config.ts
          start: npm run start-ingen-dekorator
          wait-on: http://localhost:8080/syk/sykefravaer/api/internal/isAlive
      - uses: actions/upload-artifact@v1
        if: ${{ failure() }}
        with:
          name: cypress-screenshots
          path: cypress/screenshots

  snyk-docker:
    needs: felles-workflow
    uses: navikt/flex-github-actions-workflows/.github/workflows/snyk-docker.yml@master
    with:
      image: ${{ needs.felles-workflow.outputs.image }}
    secrets: inherit
